#!/usr/bin/env bash

set -e

# NOTE: The canonical source for this file is in the clinico-omics/datains repository.

if [ -z "$PORT" ]; then
    export PORT=3000
fi

if [ -z "$DATABASE_URL" ]; then
    echo "You need to specify a database url for datains service."
    exit 1
fi

if [ -z "$WORKDIR" ]; then
    export DATAINS_WORKDIR=$HOME
else
    export DATAINS_WORKDIR=$WORKDIR
fi

if [ -z "$APP_STORE_ACCESS_TOKEN" ]; then
    echo "You must specified the access token for accessing app store."
    exit 1
fi

if [ -z "$APP_STORE_HOST" ]; then
    export APP_STORE_HOST='choppy.3steps.cn'
fi

if [ -z "$APP_STORE_PORT" ]; then
    export APP_STORE_PORT=80
fi

if [ -z "$APP_UTILITY_BIN" ]; then
    export APP_UTILITY_BIN='/app/external'
fi

if [ -z "$APP_STORE_USER_NAME" ]; then
    echo "You must specified an username for app store."
    exit 1
fi

if [ -z "$APP_STORE_PASSWORD" ]; then
    echo "You must specified a password for app store."
    exit 1
fi

if [ -z "$CROMWELL__URL" ]; then
    echo "You must specified the url of cromwell service."
    exit 1
fi

if [ -z "$CROMWELL__TOKEN" ]; then
    export CROMWELL__TOKEN=
    echo "WARNING: The datains service will access cromwell server without token, maybe cause something wrong."
fi

if [ -z "$DINGTALK_ACCESS_TOKEN" ]; then
    echo "WARNING: You need to specified a dingtalk access token, if you want to get some notifications"
fi

if [ -z "$DINGTALK_SECRET" ]; then
    echo "WARNING: You need to specified a dingtalk secret, if you want to get some notifications"
fi

# Java options
JAVA_OPTS="$JAVA_OPTS -XX:+IgnoreUnrecognizedVMOptions" # Don't barf if we see an option we don't understand (e.g. Java 9 option on Java 7/8)
JAVA_OPTS="$JAVA_OPTS -Djava.awt.headless=true"         # don't try to start AWT. Not sure this does anything but better safe than wasting memory
JAVA_OPTS="$JAVA_OPTS -Dfile.encoding=UTF-8"            # Use UTF-8

echo "Using these JAVA_OPTS: ${JAVA_OPTS}"

exec java $JAVA_OPTS -jar ./target/uberjar/datains.jar
